<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NTD Vending Machine Simulation</title>
    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --muted: #64748b;
        --text: #e5e7eb;
        --accent: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 24px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Inter, Helvetica, Arial, sans-serif;
        background: linear-gradient(180deg, #0b1020, #0a122d);
        color: var(--text);
      }
      h1 {
        margin: 0 0 12px 0;
        letter-spacing: 0.5px;
      }
      .app {
        max-width: 1100px;
        margin: 0 auto;
        display: grid;
        gap: 16px;
        grid-template-columns: 1.2fr 0.8fr;
      }
      .panel {
        background: rgba(17, 24, 39, 0.75);
        backdrop-filter: blur(6px);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 16px;
      }
      .products {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
      .card {
        background: var(--card);
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .title {
        font-weight: 600;
      }
      .price {
        color: var(--accent);
        font-weight: 600;
      }
      .stock {
        color: var(--muted);
        font-size: 12px;
      }
      button {
        border: 1px solid #374151;
        background: #0b1628;
        color: var(--text);
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.15s;
      }
      button:hover {
        transform: translateY(-1px);
        background: #0c1a33;
      }
      button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
      }
      .buy {
        background: #11233f;
      }
      .buy:hover {
        background: #0f2a54;
      }
      .buy:disabled {
        background: #0b1628;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .monospace {
        font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace;
      }
      .badge {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #334155;
        color: #cbd5e1;
      }
      .ok {
        color: #22c55e;
        border-color: #22c55e33;
      }
      .warn {
        color: #f59e0b;
        border-color: #f59e0b33;
      }
      .err {
        color: #ef4444;
        border-color: #ef444433;
      }
      .section-title {
        opacity: 0.9;
        font-weight: 600;
        margin: 8px 0;
      }
      .display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding: 12px;
        border: 1px solid #1f2937;
        border-radius: 10px;
        background: linear-gradient(180deg, #0c1528, #0a1422);
      }
      .log {
        height: 140px;
        overflow: auto;
        padding: 10px;
        border: 1px dashed #334155;
        border-radius: 8px;
        background: #0a1220;
        font-size: 13px;
        line-height: 1.4;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      .table th,
      .table td {
        padding: 6px 8px;
        border-bottom: 1px solid #1f2937;
        text-align: right;
      }
      .table th:first-child,
      .table td:first-child {
        text-align: left;
      }
      .muted {
        color: var(--muted);
      }
      .footer {
        margin-top: 8px;
        font-size: 12px;
        color: #9ca3af;
      }
      @media (max-width: 900px) {
        .app {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <h1>NTD Vending Machine Simulation</h1>
    <div class="footer">
      Coins: 1 / 5 / 10 / 20 / 50; Bills: 100 / 200 / 500 / 1000 (change given
      in coins only)
    </div>

    <div class="app">
      <div class="panel">
        <div class="display">
          <div>
            Balance: <span id="balance" class="price monospace">NT$ 0</span>
            <span id="changeStatus" class="badge ok">Change OK</span>
          </div>
          <div class="row">
            <button id="refundBtn" title="Refund all balance">Refund</button>
            <button id="clearLogBtn" title="Clear message log">
              Clear Log
            </button>
          </div>
        </div>

        <h3 class="section-title">Products</h3>
        <div id="products" class="products"></div>

        <h3 class="section-title">Messages</h3>
        <div id="log" class="log"></div>
      </div>

      <div class="panel">
        <h3 class="section-title">Insert Money</h3>
        <div class="grid2">
          <div>
            <div class="muted">Coins</div>
            <div class="row" id="coinButtons"></div>
          </div>
          <div>
            <div class="muted">Bills (not used for change)</div>
            <div class="row" id="billButtons"></div>
          </div>
        </div>

        <h3 class="section-title" style="margin-top: 14px">Change Given</h3>
        <table class="table" id="changeTable">
          <thead>
            <tr>
              <th>Denomination</th>
              <th>Qty</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td class="muted">Total</td>
              <td></td>
              <td id="changeSum" class="monospace">NT$ 0</td>
            </tr>
          </tfoot>
        </table>

        <h3 class="section-title" style="margin-top: 14px">Coin Inventory</h3>
        <table class="table" id="bankTable">
          <thead>
            <tr>
              <th>Denomination</th>
              <th>Qty</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td class="muted">Total</td>
              <td></td>
              <td id="bankSum" class="monospace">NT$ 0</td>
            </tr>
          </tfoot>
        </table>

        <div class="footer">
          Tip: If you see <span class="badge warn">May not make change</span> or
          <span class="badge err">Cannot make change</span>, try inserting coins
          closer to the product price or smaller denominations.
        </div>
      </div>
    </div>

    <script>
      (() => {
        const COINS = [50, 20, 10, 5, 1];
        const BILLS = [1000, 500, 200, 100];
        const PRODUCTS = [
          { id: "water", name: "Water", price: 25, stock: 8 },
          { id: "tea", name: "Green Tea", price: 30, stock: 6 },
          { id: "coffee", name: "Coffee", price: 40, stock: 5 },
          { id: "soda", name: "Soda", price: 35, stock: 7 },
          { id: "juice", name: "Juice", price: 45, stock: 4 },
          { id: "chips", name: "Chips", price: 28, stock: 9 },
        ];
        const bank = { 50: 10, 20: 10, 10: 20, 5: 20, 1: 50 };
        let balance = 0;
        const lastChange = {};
        const $ = (s) => document.querySelector(s);
        const el = (t, o = {}) => Object.assign(document.createElement(t), o);
        const formatNTD = (n) => `NT$ ${n.toLocaleString("en-US")}`;
        const sumBank = (b) => COINS.reduce((s, d) => s + d * (b[d] || 0), 0);

        function log(msg) {
          const box = $("#log");
          box.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br/>`;
          box.scrollTop = box.scrollHeight;
        }

        function canMakeChange(amount) {
          if (amount < 0) return false;
          const temp = { ...bank };
          for (const d of COINS) {
            const need = Math.min(Math.floor(amount / d), temp[d] || 0);
            amount -= need * d;
            temp[d] -= need;
          }
          return amount === 0;
        }

        function makeChange(amount) {
          const result = {};
          for (const d of COINS) {
            const take = Math.min(Math.floor(amount / d), bank[d] || 0);
            if (take > 0) {
              result[d] = take;
              bank[d] -= take;
              amount -= take * d;
            }
          }
          return amount === 0 ? result : null;
        }

        function refreshUI() {
          $("#balance").textContent = formatNTD(balance);
          for (const p of PRODUCTS) {
            const btn = document.getElementById(`buy-${p.id}`);
            btn.disabled =
              p.stock <= 0 ||
              balance < p.price ||
              !canMakeChange(balance - p.price);
            document.getElementById(
              `stock-${p.id}`
            ).textContent = `Stock: ${p.stock}`;
          }
          const cs = $("#changeStatus");
          cs.className = "badge";
          if (balance === 0) {
            cs.textContent = "Change OK";
            cs.classList.add("ok");
          } else if (COINS.some((d) => bank[d] === 0)) {
            cs.textContent = "May not make change";
            cs.classList.add("warn");
          } else {
            const samples = [
              1,
              2,
              3,
              4,
              5,
              7,
              9,
              11,
              balance % 50,
              balance % 20,
              balance % 10,
            ].map((x) => Math.max(0, balance - x));
            const risky = samples.some((a) => a > 0 && !canMakeChange(a));
            cs.textContent = risky ? "May not make change" : "Change OK";
            cs.classList.add(risky ? "warn" : "ok");
          }
          const tbody = $("#changeTable tbody");
          tbody.innerHTML = "";
          let sum = 0;
          Object.keys(lastChange)
            .sort((a, b) => b - a)
            .forEach((d) => {
              const cnt = lastChange[d];
              const tr = el("tr");
              tr.append(el("td", { textContent: `NT$ ${d}` }));
              tr.append(el("td", { textContent: cnt }));
              tr.append(
                el("td", {
                  textContent: formatNTD(d * cnt),
                  className: "monospace",
                })
              );
              tbody.append(tr);
              sum += d * cnt;
            });
          $("#changeSum").textContent = formatNTD(sum);

          const bdy = $("#bankTable tbody");
          bdy.innerHTML = "";
          for (const d of COINS) {
            const cnt = bank[d] || 0;
            const tr = el("tr");
            tr.append(el("td", { textContent: `NT$ ${d}` }));
            tr.append(el("td", { textContent: cnt }));
            tr.append(
              el("td", {
                textContent: formatNTD(d * cnt),
                className: "monospace",
              })
            );
            bdy.append(tr);
          }
          $("#bankSum").textContent = formatNTD(sumBank(bank));
        }

        function insertCoin(v) {
          balance += v;
          bank[v] = (bank[v] || 0) + 1;
          log(`Inserted coin ${formatNTD(v)}, balance ${formatNTD(balance)}`);
          refreshUI();
        }
        function insertBill(v) {
          balance += v;
          log(
            `Inserted bill ${formatNTD(v)}, balance ${formatNTD(
              balance
            )} (bills not added to coin bank)`
          );
          refreshUI();
        }

        function buyProduct(id) {
          const p = PRODUCTS.find((x) => x.id === id);
          if (!p) return;
          if (p.stock <= 0) {
            log(`❌ ${p.name} is sold out.`);
            return;
          }
          if (balance < p.price) {
            log(
              `❌ Not enough balance, missing ${formatNTD(p.price - balance)}`
            );
            return;
          }
          const changeAmt = balance - p.price;
          if (!canMakeChange(changeAmt)) {
            log(
              `⚠️ Cannot make change for ${formatNTD(
                changeAmt
              )}, try different amount.`
            );
            return;
          }
          p.stock -= 1;
          balance -= p.price;
          log(`✅ Dispensed: ${p.name} (Price ${formatNTD(p.price)})`);
          Object.keys(lastChange).forEach((k) => delete lastChange[k]);
          if (changeAmt > 0) {
            const change = makeChange(changeAmt);
            if (change) {
              for (const d in change) lastChange[d] = change[d];
              log(
                `Change ${formatNTD(changeAmt)}: ` +
                  Object.entries(change)
                    .map(([d, c]) => `${d}x${c}`)
                    .join(", ")
              );
              balance = 0;
            } else log(`❌ Internal error: change failed.`);
          } else log(`Exact amount, no change needed.`);
          refreshUI();
        }

        function refund() {
          if (balance === 0) {
            log("No balance to refund.");
            return;
          }
          if (!canMakeChange(balance)) {
            log(
              `❌ Cannot refund ${formatNTD(
                balance
              )}: insufficient coins for change.`
            );
            return;
          }
          const change = makeChange(balance);
          Object.keys(lastChange).forEach((k) => delete lastChange[k]);
          for (const d in change) lastChange[d] = change[d];
          log(
            `🔙 Refunded ${formatNTD(balance)}: ` +
              Object.entries(change)
                .map(([d, c]) => `${d}x${c}`)
                .join(", ")
          );
          balance = 0;
          refreshUI();
        }

        function build() {
          const list = $("#products");
          PRODUCTS.forEach((p) => {
            const card = el("div", { className: "card", id: `card-${p.id}` });
            card.append(
              el("div", { className: "title", textContent: p.name }),
              el("div", {
                className: "price",
                textContent: formatNTD(p.price),
              }),
              el("div", {
                className: "stock",
                id: `stock-${p.id}`,
                textContent: `Stock: ${p.stock}`,
              }),
              el("button", {
                className: "buy",
                id: `buy-${p.id}`,
                textContent: "Buy",
                onclick: () => buyProduct(p.id),
              })
            );
            list.append(card);
          });
          const coinBox = $("#coinButtons");
          COINS.slice()
            .reverse()
            .forEach((v) => {
              const b = el("button", {
                textContent: `NT$ ${v}`,
                title: `Insert ${v} coin`,
              });
              b.onclick = () => insertCoin(v);
              coinBox.append(b);
            });
          const billBox = $("#billButtons");
          BILLS.slice()
            .reverse()
            .forEach((v) => {
              const b = el("button", {
                textContent: `NT$ ${v}`,
                title: `Insert ${v} bill`,
              });
              b.onclick = () => insertBill(v);
              billBox.append(b);
            });
          $("#refundBtn").onclick = refund;
          $("#clearLogBtn").onclick = () => {
            $("#log").innerHTML = "";
          };
          refreshUI();
          log("System initialized. Welcome!");
        }
        build();
      })();
    </script>
  </body>
</html>
